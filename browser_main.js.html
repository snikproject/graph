<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>browser/main.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-browser_contextmenu.html">browser/contextmenu</a><ul class='methods'><li data-type='method'><a href="module-browser_contextmenu.html#.addTippy">addTippy</a></li></ul></li><li><a href="module-browser_filter-Filter.html">Filter</a><ul class='methods'><li data-type='method'><a href="module-browser_filter-Filter.html#setVisible">setVisible</a></li><li data-type='method'><a href="module-browser_filter-Filter.html#toString">toString</a></li></ul></li><li><a href="module-browser_menu.Menu.html">Menu</a><ul class='methods'><li data-type='method'><a href="module-browser_menu.Menu.html#.about">about</a></li><li data-type='method'><a href="module-browser_menu.Menu.html#.closeListener">closeListener</a></li><li data-type='method'><a href="module-browser_menu.Menu.html#.visualizationFeedback">visualizationFeedback</a></li><li data-type='method'><a href="module-browser_menu.Menu.html#addMenu">addMenu</a></li><li data-type='method'><a href="module-browser_menu.Menu.html#addOptions">addOptions</a></li><li data-type='method'><a href="module-browser_menu.Menu.html#menuData">menuData</a></li><li data-type='method'><a href="module-browser_menu.Menu.html#optionsFromJSON">optionsFromJSON</a></li><li data-type='method'><a href="module-browser_menu.Menu.html#optionsToJSON">optionsToJSON</a></li><li data-type='method'><a href="module-browser_menu.Menu.html#separateSubs">separateSubs</a></li><li data-type='method'><a href="module-browser_menu.Menu.html#setLanguage">setLanguage</a></li><li data-type='method'><a href="module-browser_menu.Menu.html#showCloseMatches">showCloseMatches</a></li></ul></li><li><a href="module-browser_search.html">browser/search</a><ul class='methods'><li data-type='method'><a href="module-browser_search.html#search">search</a></li><li data-type='method'><a href="module-browser_search.html#showSearch">showSearch</a></li><li data-type='method'><a href="module-browser_search.html#showSearchResults">showSearchResults</a></li></ul></li><li><a href="module-browser_view.View.html">View</a><ul class='methods'><li data-type='method'><a href="module-browser_view.View.html#fill">fill</a></li></ul></li><li><a href="module-graph.Graph.html">Graph</a><ul class='methods'><li data-type='method'><a href="module-graph.Graph.html#.setVisible">setVisible</a></li><li data-type='method'><a href="module-graph.Graph.html#.starStyle">starStyle</a></li><li data-type='method'><a href="module-graph.Graph.html#assimilate">assimilate</a></li><li data-type='method'><a href="module-graph.Graph.html#combineMatch">combineMatch</a></li><li data-type='method'><a href="module-graph.Graph.html#createRemoveIssue">createRemoveIssue</a></li><li data-type='method'><a href="module-graph.Graph.html#cumulativeSearch">cumulativeSearch</a></li><li data-type='method'><a href="module-graph.Graph.html#getElementsByIds">getElementsByIds</a></li><li data-type='method'><a href="module-graph.Graph.html#getSource">getSource</a></li><li data-type='method'><a href="module-graph.Graph.html#invert">invert</a></li><li data-type='method'><a href="module-graph.Graph.html#moveAllMatches">moveAllMatches</a></li><li data-type='method'><a href="module-graph.Graph.html#moveNodes">moveNodes</a></li><li data-type='method'><a href="module-graph.Graph.html#multiplex">multiplex</a></li><li data-type='method'><a href="module-graph.Graph.html#newGraph">newGraph</a></li><li data-type='method'><a href="module-graph.Graph.html#presentUri">presentUri</a></li><li data-type='method'><a href="module-graph.Graph.html#presentUris">presentUris</a></li><li data-type='method'><a href="module-graph.Graph.html#resetStyle">resetStyle</a></li><li data-type='method'><a href="module-graph.Graph.html#setSource">setSource</a></li><li data-type='method'><a href="module-graph.Graph.html#showCloseMatch">showCloseMatch</a></li><li data-type='method'><a href="module-graph.Graph.html#showDoubleStar">showDoubleStar</a></li><li data-type='method'><a href="module-graph.Graph.html#showPath">showPath</a></li><li data-type='method'><a href="module-graph.Graph.html#showStar">showStar</a></li><li data-type='method'><a href="module-graph.Graph.html#showStarMultiplexed">showStarMultiplexed</a></li><li data-type='method'><a href="module-graph.Graph.html#showStarMultiplexedNew">showStarMultiplexedNew</a></li><li data-type='method'><a href="module-graph.Graph.html#showWorm">showWorm</a></li><li data-type='method'><a href="module-graph.Graph.html#subOntologyConnectivity">subOntologyConnectivity</a></li></ul></li><li><a href="module-property.Property.html">Property</a></li></ul><h3>Modules</h3><ul><li><a href="config.module_dist.html">dist</a></li><li><a href="module-browser_benchmark.html">browser/benchmark</a><ul class='methods'><li data-type='method'><a href="module-browser_benchmark.html#.addOverlay">addOverlay</a></li></ul></li><li><a href="module-browser_chaptersearch.html">browser/chaptersearch</a><ul class='methods'><li data-type='method'><a href="module-browser_chaptersearch.html#.showChapterSearch">showChapterSearch</a></li><li data-type='method'><a href="module-browser_chaptersearch.html#~getClasses">getClasses</a></li><li data-type='method'><a href="module-browser_chaptersearch.html#~showClasses">showClasses</a></li></ul></li><li><a href="module-browser_classuse.html">browser/classuse</a></li><li><a href="module-browser_colorschemeday.html">browser/colorschemeday</a></li><li><a href="module-browser_colorschemenight.html">browser/colorschemenight</a></li><li><a href="module-browser_contextmenu.html">browser/contextmenu</a><ul class='methods'><li data-type='method'><a href="module-browser_contextmenu.html#.addTippy">addTippy</a></li></ul></li><li><a href="module-browser_contextmenuEdges.html">browser/contextmenuEdges</a><ul class='methods'><li data-type='method'><a href="module-browser_contextmenuEdges.html#~edgeLabel">edgeLabel</a></li></ul></li><li><a href="module-browser_contextmenuNodes.html">browser/contextmenuNodes</a></li><li><a href="module-browser_filter.html">browser/filter</a><ul class='methods'><li data-type='method'><a href="module-browser_filter.html#.addFilterEntries">addFilterEntries</a></li><li data-type='method'><a href="module-browser_filter.html#.fromJSON">fromJSON</a></li><li data-type='method'><a href="module-browser_filter.html#.toJSON">toJSON</a></li></ul></li><li><a href="module-browser_load.html">browser/load</a><ul class='methods'><li data-type='method'><a href="module-browser_load.html#.addFileLoadEntries">addFileLoadEntries</a></li><li data-type='method'><a href="module-browser_load.html#.loadSessionFromJsonFile">loadSessionFromJsonFile</a></li><li data-type='method'><a href="module-browser_load.html#.loadView">loadView</a></li><li data-type='method'><a href="module-browser_load.html#~addLoadEntry">addLoadEntry</a></li><li data-type='method'><a href="module-browser_load.html#~loadGraphFromJson">loadGraphFromJson</a></li><li data-type='method'><a href="module-browser_load.html#~uploadJson">uploadJson</a></li></ul></li><li><a href="module-browser_log.html">browser/log</a></li><li><a href="module-browser_main.html">browser/main</a><ul class='methods'><li data-type='method'><a href="module-browser_main.html#.fillInitialGraph">fillInitialGraph</a></li><li data-type='method'><a href="module-browser_main.html#~applyParams">applyParams</a></li><li data-type='method'><a href="module-browser_main.html#~initKeyListener">initKeyListener</a></li><li data-type='method'><a href="module-browser_main.html#~main">main</a></li><li data-type='method'><a href="module-browser_main.html#~parseParams">parseParams</a></li></ul></li><li><a href="module-browser_menu.html">browser/menu</a></li><li><a href="module-browser_progress.html">browser/progress</a></li><li><a href="module-browser_save.html">browser/save</a><ul class='methods'><li data-type='method'><a href="module-browser_save.html#.saveGraph">saveGraph</a></li><li data-type='method'><a href="module-browser_save.html#.saveJson">saveJson</a></li><li data-type='method'><a href="module-browser_save.html#.savePng">savePng</a></li><li data-type='method'><a href="module-browser_save.html#.saveSession">saveSession</a></li><li data-type='method'><a href="module-browser_save.html#.saveSvg">saveSvg</a></li><li data-type='method'><a href="module-browser_save.html#.saveUrl">saveUrl</a></li><li data-type='method'><a href="module-browser_save.html#.saveView">saveView</a></li><li data-type='method'><a href="module-browser_save.html#~stringify">stringify</a></li></ul></li><li><a href="module-browser_search.html">browser/search</a><ul class='methods'><li data-type='method'><a href="module-browser_search.html#search">search</a></li><li data-type='method'><a href="module-browser_search.html#showSearch">showSearch</a></li><li data-type='method'><a href="module-browser_search.html#showSearchResults">showSearchResults</a></li></ul></li><li><a href="module-browser_state.html">browser/state</a><ul class='methods'><li data-type='method'><a href="module-browser_state.html#.fromJSON">fromJSON</a></li><li data-type='method'><a href="module-browser_state.html#.toJSON">toJSON</a></li></ul></li><li><a href="module-browser_style.html">browser/style</a></li><li><a href="module-browser_teststyle.html">browser/teststyle</a></li><li><a href="module-browser_util.html">browser/util</a><ul class='methods'><li data-type='method'><a href="module-browser_util.html#.checkboxClickableDiv">checkboxClickableDiv</a></li><li data-type='method'><a href="module-browser_util.html#.createGitHubIssue">createGitHubIssue</a></li><li data-type='method'><a href="module-browser_util.html#.getElementById">getElementById</a></li></ul></li><li><a href="module-browser_view.html">browser/view</a><ul class='methods'><li data-type='method'><a href="module-browser_view.html#.activeState">activeState</a></li><li data-type='method'><a href="module-browser_view.html#.activeView">activeView</a></li><li data-type='method'><a href="module-browser_view.html#.reset">reset</a></li><li data-type='method'><a href="module-browser_view.html#~traverse">traverse</a></li></ul></li><li><a href="module-browser_viewLayout.html">browser/viewLayout</a><ul class='methods'><li data-type='method'><a href="module-browser_viewLayout.html#.goldenLayout">goldenLayout</a></li></ul></li><li><a href="module-edge.html">edge</a></li><li><a href="module-fuse.html">fuse</a><ul class='methods'><li data-type='method'><a href="module-fuse.html#.createIndex">createIndex</a></li><li data-type='method'><a href="module-fuse.html#.search">search</a></li></ul></li><li><a href="module-graph.html">graph</a></li><li><a href="module-lang_language.html">lang/language</a><ul class='methods'><li data-type='method'><a href="module-lang_language.html#.getIdStrings">getIdStrings</a></li><li data-type='method'><a href="module-lang_language.html#.getLanguage">getLanguage</a></li><li data-type='method'><a href="module-lang_language.html#.getString">getString</a></li><li data-type='method'><a href="module-lang_language.html#.setLanguage">setLanguage</a></li><li data-type='method'><a href="module-lang_language.html#.updateHtml">updateHtml</a></li></ul></li><li><a href="module-layout.html">layout</a><ul class='methods'><li data-type='method'><a href="module-layout.html#.positions">positions</a></li><li data-type='method'><a href="module-layout.html#.presetLayout">presetLayout</a></li><li data-type='method'><a href="module-layout.html#.run">run</a></li><li data-type='method'><a href="module-layout.html#.runCached">runCached</a></li><li data-type='method'><a href="module-layout.html#~center">center</a></li><li data-type='method'><a href="module-layout.html#~springLength">springLength</a></li><li data-type='method'><a href="module-layout.html#~storageName">storageName</a></li></ul></li><li><a href="module-loadGraphFromSparql.html">loadGraphFromSparql</a><ul class='methods'><li data-type='method'><a href="module-loadGraphFromSparql.html#~createClassNodes">createClassNodes</a></li><li data-type='method'><a href="module-loadGraphFromSparql.html#~createEdges">createEdges</a></li><li data-type='method'><a href="module-loadGraphFromSparql.html#~createInstanceNodes">createInstanceNodes</a></li><li data-type='method'><a href="module-loadGraphFromSparql.html#~createNodes">createNodes</a></li><li data-type='method'><a href="module-loadGraphFromSparql.html#~parseLabels">parseLabels</a></li><li data-type='method'><a href="module-loadGraphFromSparql.html#~selectClasses">selectClasses</a></li><li data-type='method'><a href="module-loadGraphFromSparql.html#~selectInstances">selectInstances</a></li><li data-type='method'><a href="module-loadGraphFromSparql.html#~selectTriples">selectTriples</a></li></ul></li><li><a href="module-node.html">node</a></li><li><a href="module-property.html">property</a><ul class='methods'><li data-type='method'><a href="module-property.html#.possible">possible</a></li></ul></li><li><a href="module-rdf.html">rdf</a><ul class='methods'><li data-type='method'><a href="module-rdf.html#.long">long</a></li><li data-type='method'><a href="module-rdf.html#.longPrefix">longPrefix</a></li><li data-type='method'><a href="module-rdf.html#.short">short</a></li><li data-type='method'><a href="module-rdf.html#.sub">sub</a></li></ul></li><li><a href="module-sparql.html">sparql</a><ul class='methods'><li data-type='method'><a href="module-sparql.html#.ask">ask</a></li><li data-type='method'><a href="module-sparql.html#.describe">describe</a></li><li data-type='method'><a href="module-sparql.html#.select">select</a></li></ul></li><li><a href="module-string.html">string</a><ul class='methods'><li data-type='method'><a href="module-string.html#.abbrv">abbrv</a></li></ul></li><li><a href="module-timer.html">timer</a></li></ul><h3>Global</h3><ul><li><a href="global.html#browserCheckNonTranspiled">browserCheckNonTranspiled</a></li><li><a href="global.html#browserCheckTranspiled">browserCheckTranspiled</a></li><li><a href="global.html#flatten">flatten</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#logWrap">logWrap</a></li><li><a href="global.html#menuDefaults">menuDefaults</a></li><li><a href="global.html#sayswho">sayswho</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">browser/main.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
Entry point.
@module */
import loadGraphFromSparql from "../loadGraphFromSparql.js";
import { Menu } from "./menu.js";
import Search from "./search.js";
import { loadGraphFromJsonFile } from "./load.js";
import { Graph } from "./graph.js";
import * as layout from "../layout.js";
import * as sparql from "../sparql.js";
import progress from "./progress.js";
import config from "../config.js";
import initLog from "./log.js";
import * as util from "./util.js";
import { addOverlay } from "./benchmark.js";
import * as help from "../help.js";
import { View, activeState } from "./view.js";

/** Parse browser URL POST parameters.
@return {void}
*/
function parseParams() {
	const url = new URL(window.location.href);
	const defaults = {
		endpoint: config.sparql.endpoint,
		instances: config.sparql.instances,
	};
	return Object.assign(defaults, {
		empty: url.searchParams.get("empty") !== null,
		clazz: url.searchParams.get("class"),
		jsonUrl: url.searchParams.get("json"),
		...(url.searchParams.get("sparql") &amp;&amp; { endpoint: url.searchParams.get("sparql") }), // don't overwrite default with null
		// load and show instances when loading from endpoint, not only class
		// specify either without value ...&amp;instances or as ...&amp;instances=true
		...(url.searchParams.get("instances") !== null &amp;&amp; { instances: url.searchParams.get("instances") === "" || url.searchParams.get("instances") === true }),
		virtual: url.searchParams.get("virtual") !== null, // create "virtual triples" to visualize connections like domain-range
		rdfGraph: url.searchParams.get("graph"),
		sub: url.searchParams.get("sub"),
		benchmark: url.searchParams.get("benchmark") !== null,
	});
}

/**
 * Apply parameters.
@param {Graph} graph the graph to apply the params to
@param {params} params parameter object
@return {void}
 */
async function applyParams(graph, params) {
	try {
		if (params.benchmark) {
			addOverlay(graph.cy);
		}

		if (params.empty) {
			log.info(`Parameter "empty" detected. Skip loading and display file load prompt.`);
			const loadArea = document.getElementById("loadarea");
			const center = document.createElement("center");
			loadArea.appendChild(center);
			center.innerHTML += `&lt;button id="load-button" style="font-size:10vh;margin-top:20vh">Datei Laden
      &lt;input id="load-input" type="file" style="display:none">&lt;/input>
      &lt;/button>`;
			const loadInput = document.getElementById("load-input");
			document.getElementById("load-button").onclick = () => {
				loadInput.click();
			};
			loadInput.addEventListener("change", (event) => {
				loadArea.removeChild(center);
				graph.cy.resize(); // fix mouse cursor position, see https://stackoverflow.com/questions/23461322/cytoscape-js-wrong-mouse-pointer-position-after-container-change
				loadGraphFromJsonFile(graph)(event);
			});
			return;
		}
		if (params.jsonUrl) {
			log.info(`Loading from JSON URL ` + params.jsonUrl);
			const json = await (await fetch(params.jsonUrl)).json();
			graph.cy.add(json);
			layout.run(graph.cy, layout.euler);
			return;
		}
		log.debug("Loading from SPARQL Endpoint " + params.endpoint);
		config.sparql.endpoint = params.endpoint; // loadGraphFromSparql loads from config.sparql.endpoint
		const graphs = [];
		if (params.endpoint === sparql.SNIK_ENDPOINT) {
			let subs = [];
			if (params.sub) {
				subs = params.sub.split(",");
			}
			if (subs.length === 0) {
				// either not present or empty value
				subs = [...config.helperGraphs, ...config.defaultSubOntologies];
			}
			graphs.push(...subs.map((g) => sparql.SNIK_PREFIX + g));
		} else if (params.rdfGraph) {
			graphs.push(params.rdfGraph);
			config.sparql.graph = params.rdfGraph;
		}
		console.debug(`Loading graph with${params.instances ? "" : "out"} instances.`);
		{
			await loadGraphFromSparql(graph.cy, graphs, params.instances, params.virtual);
		}
		graph.instancesLoaded = params.instances;
		if (params.endpoint === sparql.SNIK_ENDPOINT) {
			await layout.runCached(graph.cy, layout.euler, config.defaultSubOntologies, false); // todo: use the correct subs
		} else {
			await layout.run(graph.cy, layout.euler);
		}

		if (params.clazz) {
			log.info(`Parameter "class" detected. Centering on URI ${params.clazz}.`);
			// shouldn't be needed in theory due to the await in front of layout.run/runCached but is needed in practice
			setTimeout(() => graph.presentUri(params.clazz), 300);
		}
	} catch (e) {
		log.error(e);
		log.error("Error initializing SNIK Graph " + e);
	}
}

/** Fill the initial Graph based on the URL GET parameters.
@param {Graph} graph the initial graph
@return {void}
*/
export async function fillInitialGraph(graph) {
	await progress(async () => {
		const params = parseParams();
		await applyParams(graph, params);
		graph.menu = new Menu(params.instances);
		new Search(util.getElementById("search"));
		help.init();
	});
	help.init();
}

const clipboard = [];

/** Relegate keypresses to the active view.
@return {void}
*/
function initKeyListener() {
	document.documentElement.addEventListener("keydown", (e) => {
		// prevent keydown listener from firing on input fields
		// See https://stackoverflow.com/questions/40876422/jquery-disable-keydown-in-input-and-textareas
		const el = e.target;
		if (!el || el.nodeName !== "BODY") {
			return;
		}

		const layoutState = activeState();
		if (e.code === "Delete" || e.code === "Backspace") {
			// backspace (for mac) or delete key
			layoutState.cy.remove(":selected");
		}
		// Copy
		if (e.code === "KeyS" || e.code === "KeyC") {
			const selected = layoutState.cy.nodes(":selected");
			if (selected.size() === 0) {
				return;
			} // do nothing when nothing selected
			clipboard.length = 0;
			clipboard.push(...selected.map((node) => node.id()));
			log.debug(`Copied ${clipboard.length} elements from ${layoutState.name}.`);
			log.info("Partial graph copied!");
		}
		// Paste
		if (e.code === "KeyP" || e.code === "KeyV") {
			layoutState.cy.startBatch();
			layoutState.cy.elements().unselect();
			const nodes = layoutState.graph.getElementsByIds(clipboard);
			Graph.setVisible(nodes, true);

			layoutState.cy.endBatch();

			const visibleNodes = layoutState.cy.nodes(".unfiltered").not(".hidden");
			const edges = nodes.edgesWith(visibleNodes);
			const pasted = nodes.union(edges);
			Graph.setVisible(pasted, true);
			pasted.select(); // select all pasted nodes so that they are more visible above the other nodes

			layoutState.cy.fit(layoutState.cy.elements(".unfiltered").not(".hidden")); // needs to be outside the batch to fit correctly
			log.debug(`Pasted ${clipboard.length} elements into ${layoutState.name}.`);
			log.info("Partial graph inserted!");
		}
	});
}

/** Entry point. Is run when DOM is loaded.
@return {void}
*/
async function main() {
	console.groupCollapsed("Initializing");
	console.time("Initializing");

	initLog();
	initKeyListener();
	MicroModal.init({ openTrigger: "data-custom-open" });

	for (let i = 0; i &lt; config.multiview.initialTabs; i++) {
		const view = new View();
		await view.initialized;
	}

	console.timeEnd("Initializing");
	console.groupEnd();
}

document.addEventListener("DOMContentLoaded", main);
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a> on Wed Aug 25 2021 11:31:19 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
